<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能音乐交易看板</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: transparent;
            font-family: Arial, sans-serif;
        }
        .container {
            width: 450px;
            height: 320px;
            background: rgba(0, 0, 0, 0.92);
            border-radius: 10px;
            padding: 12px;
            border: 2px solid #333;
            position: relative;
        }
        
        /* 指数显示区域 */
        .indices-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .index-card {
            background: rgba(40, 40, 60, 0.7);
            border-radius: 6px;
            padding: 8px;
            border-left: 3px solid #666;
        }
        
        .index-name {
            color: #ccc;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        .index-price {
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin: 2px 0;
        }
        
        .index-change {
            font-size: 11px;
            font-weight: bold;
        }
        
        .positive { color: #00ff00; }
        .negative { color: #ff0000; }
        .neutral { color: #cccccc; }
        
        /* 图表区域 */
        .chart-container {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
            background: rgba(30, 30, 45, 0.8);
            border-radius: 4px;
            overflow: hidden;
        }
        
        /* 三色灯投票区域 */
        .voting-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .lights-container {
            display: flex;
            gap: 8px;
        }
        
        .light-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .light {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .light:hover {
            transform: scale(1.15);
            border-color: gold;
        }
        
        .green { background-color: #00ff00; }
        .red { background-color: #ff0000; }
        .white { background-color: #ffffff; }
        
        /* 颜色深度级别 */
        .green.level-1 { background-color: #00ff00; }
        .green.level-2 { background-color: #00cc00; }
        .green.level-3 { background-color: #009900; }
        .green.level-4 { background-color: #006600; }
        .green.level-5 { background-color: #004400; }
        
        .red.level-1 { background-color: #ff0000; }
        .red.level-2 { background-color: #cc0000; }
        .red.level-3 { background-color: #990000; }
        .red.level-4 { background-color: #660000; }
        .red.level-5 { background-color: #440000; }
        
        .white.level-1 { background-color: #ffffff; }
        .white.level-2 { background-color: #cccccc; }
        .white.level-3 { background-color: #999999; }
        .white.level-4 { background-color: #666666; }
        .white.level-5 { background-color: #444444; }
        
        .vote-count {
            font-size: 9px;
            color: #ccc;
            margin-top: 2px;
            font-weight: bold;
        }
        
        /* 音乐控制区域 */
        .music-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .music-btn {
            background: #444;
            border: none;
            border-radius: 3px;
            color: white;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .music-status {
            font-size: 10px;
            color: #ccc;
        }
        
        /* 状态指示器 */
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 3px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .music-intensity {
            font-size: 9px;
            color: #888;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 指数显示区域 -->
        <div class="indices-section">
            <div class="index-card">
                <div class="index-name">上证指数 <span class="status-indicator" id="shStatus"></span></div>
                <div class="index-price" id="shPrice">--.--</div>
                <div class="index-change" id="shChange">0.00%</div>
            </div>
            <div class="index-card">
                <div class="index-name">标普500 <span class="status-indicator" id="spxStatus"></span></div>
                <div class="index-price" id="spxPrice">--.--</div>
                <div class="index-change" id="spxChange">0.00%</div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="chart-container">
            <div id="tradingview_chart"></div>
        </div>
        
        <!-- 投票和音乐控制区域 -->
        <div class="voting-section">
            <div class="lights-container">
                <div class="light-wrapper" title="看涨投票">
                    <div class="light green level-1" onclick="vote('green')">↑</div>
                    <div class="vote-count" id="greenCount">0</div>
                    <div class="music-intensity" id="greenIntensity">欢快+0</div>
                </div>
                <div class="light-wrapper" title="中性投票">
                    <div class="light white level-1" onclick="vote('white')">→</div>
                    <div class="vote-count" id="whiteCount">0</div>
                    <div class="music-intensity" id="whiteIntensity">平和+0</div>
                </div>
                <div class="light-wrapper" title="看跌投票">
                    <div class="light red level-1" onclick="vote('red')">↓</div>
                    <div class="vote-count" id="redCount">0</div>
                    <div class="music-intensity" id="redIntensity">悲伤+0</div>
                </div>
            </div>
            
            <div class="music-controls">
                <button class="music-btn" onclick="toggleMusic()" id="musicToggle">播放音乐</button>
                <div class="music-status" id="musicStatus">准备就绪</div>
            </div>
        </div>
    </div>

    <!-- TradingView脚本 -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // 初始化变量
        let votes = { green: 0, white: 0, red: 0 };
        let musicEnabled = false;
        let currentAudio = null;
        let currentMood = 'neutral';
        
        // 音乐库 - 使用免版税音乐链接:cite[7]
        const musicLibrary = {
            happy: [
                { name: "欢快曲目1", url: "https://example.com/happy1.mp3", intensity: 1 },
                { name: "欢快曲目2", url: "https://example.com/happy2.mp3", intensity: 2 },
                { name: "欢快曲目3", url: "https://example.com/happy3.mp3", intensity: 3 }
            ],
            neutral: [
                { name: "平和曲目1", url: "https://example.com/neutral1.mp3", intensity: 1 },
                { name: "平和曲目2", url: "https://example.com/neutral2.mp3", intensity: 2 }
            ],
            sad: [
                { name: "悲伤曲目1", url: "https://example.com/sad1.mp3", intensity: 1 },
                { name: "悲伤曲目2", url: "https://example.com/sad2.mp3", intensity: 2 },
                { name: "悲伤曲目3", url: "https://example.com/sad3.mp3", intensity: 3 }
            ]
        };

        // 页面加载完成后执行
        window.addEventListener('load', function() {
            loadVotes();
            initTradingView();
            setupIndexData();
            updateMusicIntensityDisplay();
        });

        // 加载投票数据
        function loadVotes() {
            try {
                const saved = localStorage.getItem('tradingVotes');
                if (saved) {
                    votes = JSON.parse(saved);
                    updateVoteDisplay();
                }
            } catch (e) {
                console.log('加载投票数据失败:', e);
            }
        }

        // 投票功能
        function vote(color) {
            votes[color]++;
            try {
                localStorage.setItem('tradingVotes', JSON.stringify(votes));
            } catch (e) {
                console.log('保存投票数据失败:', e);
            }
            updateVoteDisplay();
            updateMusicBasedOnVotes();
            
            // 点击效果
            const light = document.querySelector(`.light.${color}`);
            light.style.boxShadow = '0 0 8px gold';
            setTimeout(() => { light.style.boxShadow = 'none'; }, 300);
        }

        // 更新投票显示
        function updateVoteDisplay() {
            ['green', 'white', 'red'].forEach(color => {
                const count = votes[color] || 0;
                document.getElementById(`${color}Count`).textContent = count;
                
                const light = document.querySelector(`.light.${color}`);
                if (light) {
                    const level = Math.min(Math.floor(count / 3) + 1, 5);
                    light.className = `light ${color} level-${level}`;
                }
            });
        }

        // 更新音乐强度显示
        function updateMusicIntensityDisplay() {
            document.getElementById('greenIntensity').textContent = `欢快+${votes.green}`;
            document.getElementById('whiteIntensity').textContent = `平和+${votes.white}`;
            document.getElementById('redIntensity').textContent = `悲伤+${votes.red}`;
        }

        // 根据投票更新音乐
        function updateMusicBasedOnVotes() {
            if (!musicEnabled) return;
            
            updateMusicIntensityDisplay();
            
            // 确定主导情绪（基于投票）
            let dominantMood = 'neutral';
            if (votes.green > votes.red && votes.green > votes.white) {
                dominantMood = 'happy';
            } else if (votes.red > votes.green && votes.red > votes.white) {
                dominantMood = 'sad';
            }
            
            // 确定强度级别
            let intensity = 1;
            const dominantVotes = Math.max(votes.green, votes.red, votes.white);
            if (dominantVotes >= 10) intensity = 3;
            else if (dominantVotes >= 5) intensity = 2;
            
            playMusic(dominantMood, intensity);
        }

        // 播放音乐
        function playMusic(mood, intensity = 1) {
            if (!musicEnabled) return;
            
            // 停止当前音乐
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            const availableTracks = musicLibrary[mood] || musicLibrary.neutral;
            const selectedTrack = availableTracks.find(track => track.intensity === intensity) || availableTracks[0];
            
            if (selectedTrack) {
                currentAudio = new Audio(selectedTrack.url);
                currentAudio.loop = true;
                currentAudio.volume = 0.3; // 降低音量避免干扰
                
                currentAudio.play().catch(e => {
                    console.log('音乐播放失败:', e);
                    document.getElementById('musicStatus').textContent = '播放失败';
                });
                
                document.getElementById('musicStatus').textContent = `${mood === 'happy' ? '欢快' : mood === 'sad' ? '悲伤' : '平和'}音乐 Lv.${intensity}`;
                currentMood = mood;
            }
        }

        // 切换音乐开关
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const toggleBtn = document.getElementById('musicToggle');
            
            if (musicEnabled) {
                toggleBtn.textContent = '停止音乐';
                updateMusicBasedOnVotes();
            } else {
                toggleBtn.textContent = '播放音乐';
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                document.getElementById('musicStatus').textContent = '已停止';
            }
        }

        // 初始化TradingView图表
        function initTradingView() {
            if (typeof TradingView !== 'undefined') {
                new TradingView.widget({
                    "width": "100%",
                    "height": "150",
                    "symbol": "BINANCE:BTCUSDT",
                    "interval": "5",
                    "timezone": "Asia/Shanghai",
                    "theme": "dark",
                    "style": "1",
                    "locale": "zh_CN",
                    "enable_publishing": false,
                    "allow_symbol_change": false,
                    "container_id": "tradingview_chart",
                    "hide_top_toolbar": true,
                    "hide_legend": true,
                    "hide_side_toolbar": true,
                    "studies": ["volume@tv-basicstudies"],
                    "disabled_features": [
                        "header_widget", "left_toolbar", "footer_screenshot", 
                        "volume_force_overlay", "show_logo_on_all_charts"
                    ]
                });
            }
        }

        // 设置指数数据（示例实现）
        function setupIndexData() {
            // 上证指数数据（示例）
            updateIndexData('sh', 3200.45, 1.2);
            
            // 标普500数据（示例）
            updateIndexData('spx', 4450.32, -0.8);
            
            // 模拟实时更新
            setInterval(() => {
                // 这里可以替换为真实的API调用:cite[1]:cite[5]
                const shChange = (Math.random() - 0.5) * 2;
                const spxChange = (Math.random() - 0.5) * 2;
                
                updateIndexData('sh', 3200 + Math.random() * 100, shChange);
                updateIndexData('spx', 4450 + Math.random() * 50, spxChange);
                
                // 根据指数变化自动调整音乐（可选功能）
                autoAdjustMusicByMarket();
                
            }, 5000); // 每5秒更新一次
        }

        // 更新指数显示
        function updateIndexData(index, price, changePercent) {
            const priceElement = document.getElementById(`${index}Price`);
            const changeElement = document.getElementById(`${index}Change`);
            const statusElement = document.getElementById(`${index}Status`);
            
            if (priceElement) priceElement.textContent = price.toFixed(2);
            if (changeElement) {
                changeElement.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                changeElement.className = `index-change ${changePercent > 0 ? 'positive' : changePercent < 0 ? 'negative' : 'neutral'}`;
            }
            if (statusElement) {
                statusElement.style.backgroundColor = changePercent > 0 ? '#00ff00' : changePercent < 0 ? '#ff0000' : '#cccccc';
            }
        }

        // 根据市场表现自动调整音乐
        function autoAdjustMusicByMarket() {
            if (!musicEnabled) return;
            
            // 获取两个指数的平均变化
            const shChange = parseFloat(document.getElementById('shChange').textContent);
            const spxChange = parseFloat(document.getElementById('spxChange').textContent);
            const avgChange = (shChange + spxChange) / 2;
            
            // 如果市场整体上涨且当前不是欢快音乐，自动调整
            if (avgChange > 0.5 && currentMood !== 'happy') {
                playMusic('happy', 1);
            }
            // 如果市场整体下跌且当前不是悲伤音乐，自动调整
            else if (avgChange < -0.5 && currentMood !== 'sad') {
                playMusic('sad', 1);
            }
        }

        // 重置投票（右键点击）
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            if (confirm('确定要重置所有投票和音乐设置吗？')) {
                votes = { green: 0, white: 0, red: 0 };
                try {
                    localStorage.setItem('tradingVotes', JSON.stringify(votes));
                } catch (e) {
                    console.log('重置投票数据失败:', e);
                }
                updateVoteDisplay();
                updateMusicIntensityDisplay();
                if (musicEnabled) {
                    playMusic('neutral', 1);
                }
            }
        });
    </script>
</body>
</html>
