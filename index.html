
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能音乐交易看板</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: transparent;
            font-family: Arial, sans-serif;
        }
        .container {
            width: 500px;
            height: 350px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #333;
        }
        
        /* 指数显示区域 */
        .indices-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .index-card {
            background: rgba(40, 40, 60, 0.8);
            border-radius: 6px;
            padding: 8px;
            border-left: 3px solid #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .index-card.active {
            background: rgba(60, 80, 100, 0.9);
            border-left: 3px solid gold;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .index-card:hover {
            transform: scale(1.02);
        }
        
        .index-name {
            color: #ccc;
            font-size: 11px;
            margin-bottom: 3px;
        }
        
        .index-price {
            color: white;
            font-size: 14px;
            font-weight: bold;
            margin: 2px 0;
        }
        
        .index-change {
            font-size: 10px;
            font-weight: bold;
        }
        
        .positive { color: #00ff00; }
        .negative { color: #ff0000; }
        .neutral { color: #cccccc; }
        
        /* 图表区域 */
        .chart-container {
            width: 100%;
            height: 160px;
            margin-bottom: 10px;
            background: rgba(30, 30, 45, 0.8);
            border-radius: 4px;
            overflow: hidden;
        }
        
        /* 投票和音乐区域 */
        .control-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 80px;
        }
        
        .voting-area {
            background: rgba(50, 50, 70, 0.7);
            border-radius: 6px;
            padding: 8px;
        }
        
        .voting-title {
            color: #ccc;
            font-size: 11px;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .lights-container {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .light-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .light {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .light:hover {
            transform: scale(1.2);
            border-color: gold;
        }
        
        .green { background-color: #00ff00; }
        .red { background-color: #ff0000; }
        .white { background-color: #ffffff; }
        
        /* 颜色深度级别 */
        .green.level-1 { background-color: #00ff00; }
        .green.level-2 { background-color: #00cc00; }
        .green.level-3 { background-color: #009900; }
        .green.level-4 { background-color: #006600; }
        .green.level-5 { background-color: #004400; }
        
        .red.level-1 { background-color: #ff0000; }
        .red.level-2 { background-color: #cc0000; }
        .red.level-3 { background-color: #990000; }
        .red.level-4 { background-color: #660000; }
        .red.level-5 { background-color: #440000; }
        
        .white.level-1 { background-color: #ffffff; }
        .white.level-2 { background-color: #cccccc; }
        .white.level-3 { background-color: #999999; }
        .white.level-4 { background-color: #666666; }
        .white.level-5 { background-color: #444444; }
        
        .vote-count {
            font-size: 10px;
            color: #ccc;
            margin-top: 3px;
            font-weight: bold;
        }
        
        /* 音乐控制区域 */
        .music-area {
            background: rgba(50, 50, 70, 0.7);
            border-radius: 6px;
            padding: 8px;
        }
        
        .music-title {
            color: #ccc;
            font-size: 11px;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .music-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .music-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 15px;
            color: white;
            padding: 6px 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .music-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        .music-status {
            font-size: 10px;
            color: #ccc;
            text-align: center;
        }
        
        .current-track {
            font-size: 9px;
            color: #888;
            text-align: center;
        }
        
        .volume-control {
            width: 80%;
            margin: 3px 0;
        }
        
        /* 状态指示器 */
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 3px;
        }
        
        .debug-info {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 8px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="debug-info" id="debugInfo">状态: 正常</div>
        
        <!-- 指数选择区域 -->
        <div class="indices-section">
            <div class="index-card active" onclick="selectIndex('btc')">
                <div class="index-name">比特币/USDT <span class="status-indicator" id="btcStatus" style="background-color: #ccc;"></span></div>
                <div class="index-price" id="btcPrice">--.--</div>
                <div class="index-change" id="btcChange">0.00%</div>
            </div>
            <div class="index-card" onclick="selectIndex('sh')">
                <div class="index-name">上证指数 <span class="status-indicator" id="shStatus" style="background-color: #ccc;"></span></div>
                <div class="index-price" id="shPrice">--.--</div>
                <div class="index-change" id="shChange">0.00%</div>
            </div>
            <div class="index-card" onclick="selectIndex('spx')">
                <div class="index-name">标普500 <span class="status-indicator" id="spxStatus" style="background-color: #ccc;"></span></div>
                <div class="index-price" id="spxPrice">--.--</div>
                <div class="index-change" id="spxChange">0.00%</div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="chart-container">
            <div id="tradingview_chart"></div>
        </div>
        
        <!-- 控制和音乐区域 -->
        <div class="control-section">
            <!-- 投票区域 -->
            <div class="voting-area">
                <div class="voting-title">观众情绪投票 ↑→↓</div>
                <div class="lights-container">
                    <div class="light-wrapper" title="看涨投票">
                        <div class="light green level-1" onclick="vote('green')">↑</div>
                        <div class="vote-count" id="greenCount">0</div>
                    </div>
                    <div class="light-wrapper" title="中性投票">
                        <div class="light white level-1" onclick="vote('white')">→</div>
                        <div class="vote-count" id="whiteCount">0</div>
                    </div>
                    <div class="light-wrapper" title="看跌投票">
                        <div class="light red level-1" onclick="vote('red')">↓</div>
                        <div class="vote-count" id="redCount">0</div>
                    </div>
                </div>
            </div>
            
            <!-- 音乐控制区域 -->
            <div class="music-area">
                <div class="music-title">智能背景音乐</div>
                <div class="music-controls">
                    <button class="music-btn" onclick="toggleMusic()" id="musicToggle">🎵 播放音乐</button>
                    <div class="music-status" id="musicStatus">选择指数开始</div>
                    <div class="current-track" id="currentTrack">-</div>
                    <input type="range" class="volume-control" min="0" max="100" value="30" oninput="changeVolume(this.value)">
                </div>
            </div>
        </div>
    </div>

    <!-- TradingView脚本 -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // 初始化变量 - 简化版本
        let votes = {
            btc: { green: 0, white: 0, red: 0 },
            sh: { green: 0, white: 0, red: 0 },
            spx: { green: 0, white: 0, red: 0 }
        };
        let musicEnabled = false;
        let currentAudio = null;
        let currentIndex = 'btc';
        let globalVolume = 0.3;

        // 使用更可靠的音乐源
        const musicLibrary = {
            happy: [
                { 
                    name: "欢乐时光", 
                    // 使用可靠的第三方音乐源
                    url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_d17187f392.mp3?filename=upbeat-happy-ukulele-123277.mp3",
                    intensity: 1 
                },
                { 
                    name: "阳光明媚", 
                    url: "https://cdn.pixabay.com/download/audio/2021/10/25/audio_1a4d1a3e2c.mp3?filename=summer-walk-152722.mp3",
                    intensity: 2 
                }
            ],
            neutral: [
                { 
                    name: "平和心境", 
                    url: "https://cdn.pixabay.com/download/audio/2022/03/19/audio_1a6ab45b7d.mp3?filename=ambient-piano-117363.mp3",
                    intensity: 1 
                }
            ],
            sad: [
                { 
                    name: "雨中沉思", 
                    url: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_6b8c1f5c4f.mp3?filename=sad-ambient-piano-117364.mp3",
                    intensity: 1 
                }
            ]
        };

        // 调试信息
        function debug(message) {
            console.log('DEBUG:', message);
            document.getElementById('debugInfo').textContent = message;
        }

        // 页面加载完成后执行
        window.addEventListener('load', function() {
            debug('页面加载完成');
            loadVotes();
            initTradingView();
            setupIndexData();
            updateDisplay();
            
            // 添加点击事件监听器 - 确保投票按钮能工作
            document.querySelectorAll('.light').forEach(light => {
                light.addEventListener('click', function() {
                    const color = this.classList[1]; // 获取颜色类名
                    vote(color);
                });
            });
        });

        // 选择指数
        function selectIndex(index) {
            debug(`选择指数: ${index}`);
            currentIndex = index;
            
            // 更新UI显示
            document.querySelectorAll('.index-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // 更新投票显示
            updateDisplay();
            
            // 如果音乐开启，根据新指数调整音乐
            if (musicEnabled) {
                updateMusicBasedOnMarket();
            }
        }

        // 加载投票数据
        function loadVotes() {
            try {
                const saved = localStorage.getItem('tradingVotes');
                if (saved) {
                    votes = JSON.parse(saved);
                    debug('投票数据加载成功');
                } else {
                    debug('无保存的投票数据');
                }
            } catch (e) {
                debug('加载投票数据失败');
            }
        }

        // 保存投票数据
        function saveVotes() {
            try {
                localStorage.setItem('tradingVotes', JSON.stringify(votes));
            } catch (e) {
                debug('保存投票数据失败');
            }
        }

        // 投票功能 - 修复版本
        function vote(color) {
            debug(`投票: ${color} for ${currentIndex}`);
            
            if (!votes[currentIndex]) {
                votes[currentIndex] = { green: 0, white: 0, red: 0 };
            }
            
            votes[currentIndex][color]++;
            saveVotes();
            updateDisplay();
            
            // 点击效果
            const light = document.querySelector(`.light.${color}`);
            if (light) {
                light.style.transform = 'scale(1.3)';
                light.style.boxShadow = '0 0 15px gold';
                setTimeout(() => {
                    light.style.transform = 'scale(1)';
                    light.style.boxShadow = 'none';
                }, 300);
            }
            
            // 如果音乐开启，根据投票调整音乐
            if (musicEnabled) {
                updateMusicBasedOnVotes();
            }
        }

        // 更新显示
        function updateDisplay() {
            const currentVotes = votes[currentIndex] || { green: 0, white: 0, red: 0 };
            debug(`更新显示: ${currentIndex} - ${JSON.stringify(currentVotes)}`);
            
            ['green', 'white', 'red'].forEach(color => {
                const count = currentVotes[color] || 0;
                const countElement = document.getElementById(`${color}Count`);
                if (countElement) {
                    countElement.textContent = count;
                    debug(`设置 ${color}Count: ${count}`);
                }
                
                const light = document.querySelector(`.light.${color}`);
                if (light) {
                    const level = Math.min(Math.floor(count / 2) + 1, 5);
                    light.className = `light ${color} level-${level}`;
                }
            });
        }

        // 根据投票调整音乐
        function updateMusicBasedOnVotes() {
            if (!musicEnabled) return;
            
            const currentVotes = votes[currentIndex] || { green: 0, white: 0, red: 0 };
            
            // 确定主导情绪（基于投票）
            let mood = 'neutral';
            if (currentVotes.green > currentVotes.red && currentVotes.green > currentVotes.white) {
                mood = 'happy';
            } else if (currentVotes.red > currentVotes.green && currentVotes.red > currentVotes.white) {
                mood = 'sad';
            }
            
            // 确定强度级别
            const dominantVotes = Math.max(currentVotes.green, currentVotes.red, currentVotes.white);
            let intensity = 1;
            if (dominantVotes >= 5) intensity = 2;
            if (dominantVotes >= 10) intensity = 3;
            
            playMusic(mood, intensity);
        }

        // 根据市场行情调整音乐
        function updateMusicBasedOnMarket() {
            if (!musicEnabled) return;
            
            // 模拟市场数据
            const changes = {
                btc: (Math.random() - 0.5) * 3,
                sh: (Math.random() - 0.5) * 2,
                spx: (Math.random() - 0.5) * 1.5
            };
            
            const changePercent = changes[currentIndex] || 0;
            
            let mood = 'neutral';
            if (changePercent > 0.5) mood = 'happy';
            else if (changePercent < -0.5) mood = 'sad';
            
            playMusic(mood, 1);
        }

        // 播放音乐 - 修复版本
        function playMusic(mood, intensity = 1) {
            debug(`播放音乐: ${mood} 强度: ${intensity}`);
            
            if (!musicEnabled) {
                debug('音乐未启用');
                return;
            }
            
            // 停止当前音乐
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            const availableTracks = musicLibrary[mood] || musicLibrary.neutral;
            const selectedTrack = availableTracks[0]; // 简化：总是使用第一个曲目
            
            if (selectedTrack && selectedTrack.url) {
                debug(`尝试播放: ${selectedTrack.name}`);
                
                currentAudio = new Audio();
                currentAudio.src = selectedTrack.url;
                currentAudio.loop = true;
                currentAudio.volume = globalVolume;
                
                // 添加事件监听器
                currentAudio.addEventListener('canplaythrough', function() {
                    debug('音乐可以播放');
                });
                
                currentAudio.addEventListener('error', function(e) {
                    debug(`音乐播放错误: ${e.target.error.code}`);
                    document.getElementById('musicStatus').textContent = '音乐加载失败';
                });
                
                currentAudio.addEventListener('playing', function() {
                    debug('音乐开始播放');
                    const moodText = mood === 'happy' ? '🎉 欢快' : mood === 'sad' ? '😢 悲伤' : '😐 平和';
                    document.getElementById('musicStatus').textContent = `${moodText} 音乐`;
                    document.getElementById('currentTrack').textContent = `${selectedTrack.name} Lv.${intensity}`;
                });
                
                // 尝试播放
                const playPromise = currentAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        debug('音乐播放成功');
                    }).catch(error => {
                        debug(`播放被阻止: ${error}`);
                        document.getElementById('musicStatus').textContent = '点击允许播放';
                    });
                }
            } else {
                debug('未找到合适的音乐曲目');
            }
        }

        // 切换音乐开关 - 修复版本
        function toggleMusic() {
            debug(`切换音乐状态: ${musicEnabled ? '关闭' : '开启'}`);
            
            if (!musicEnabled) {
                // 先尝试播放一个无声音频来获得用户交互许可
                const silentAudio = new Audio();
                silentAudio.src = "data:audio/wav;base64,UklGRnoAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoAAAC";
                
                silentAudio.play().then(() => {
                    silentAudio.pause();
                    musicEnabled = true;
                    document.getElementById('musicToggle').textContent = '⏹️ 停止音乐';
                    document.getElementById('musicStatus').textContent = '音乐开启中...';
                    
                    // 等待一下再播放音乐
                    setTimeout(() => {
                        updateMusicBasedOnMarket();
                    }, 500);
                    
                }).catch(e => {
                    debug('需要用户交互');
                    alert('请先点击页面任意位置，然后再次点击播放按钮');
                });
            } else {
                musicEnabled = false;
                document.getElementById('musicToggle').textContent = '🎵 播放音乐';
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                document.getElementById('musicStatus').textContent = '音乐已停止';
                document.getElementById('currentTrack').textContent = '-';
            }
        }

        // 调整音量
        function changeVolume(value) {
            globalVolume = value / 100;
            if (currentAudio) {
                currentAudio.volume = globalVolume;
            }
            debug(`音量调整: ${value}%`);
        }

        // 初始化TradingView图表
        function initTradingView() {
            if (typeof TradingView !== 'undefined') {
                new TradingView.widget({
                    "width": "100%",
                    "height": "160",
                    "symbol": "BINANCE:BTCUSDT",
                    "interval": "5",
                    "timezone": "Asia/Shanghai",
                    "theme": "dark",
                    "style": "1",
                    "locale": "zh_CN",
                    "enable_publishing": false,
                    "hide_top_toolbar": true,
                    "hide_legend": true,
                    "hide_side_toolbar": true,
                    "container_id": "tradingview_chart"
                });
                debug('TradingView图表初始化完成');
            }
        }

        // 设置指数数据
        function setupIndexData() {
            debug('开始设置指数数据');
            
            // 初始化数据
            updateIndexData('btc', 45000.00, 0.0);
            updateIndexData('sh', 3200.45, 0.0);
            updateIndexData('spx', 4450.32, 0.0);
            
            // 模拟实时更新
            setInterval(() => {
                updateIndexData('btc', 45000 + (Math.random() - 0.5) * 1000, (Math.random() - 0.5) * 3);
                updateIndexData('sh', 3200 + (Math.random() - 0.5) * 50, (Math.random() - 0.5) * 2);
                updateIndexData('spx', 4450 + (Math.random() - 0.5) * 30, (Math.random() - 0.5) * 1.5);
                
                if (musicEnabled) {
                    updateMusicBasedOnMarket();
                }
            }, 3000);
        }

        // 更新指数显示
        function updateIndexData(index, price, changePercent) {
            const priceElement = document.getElementById(`${index}Price`);
            const changeElement = document.getElementById(`${index}Change`);
            const statusElement = document.getElementById(`${index}Status`);
            
            if (priceElement) priceElement.textContent = price.toFixed(2);
            if (changeElement) {
                changeElement.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                changeElement.className = `index-change ${changePercent > 0 ? 'positive' : changePercent < 0 ? 'negative' : 'neutral'}`;
            }
            if (statusElement) {
                statusElement.style.backgroundColor = changePercent > 0 ? '#00ff00' : changePercent < 0 ? '#ff0000' : '#cccccc';
            }
        }

        // 重置当前指数的投票
        function resetVotes() {
            if (confirm(`确定要重置${currentIndex.toUpperCase()}的投票吗？`)) {
                votes[currentIndex] = { green: 0, white: 0, red: 0 };
                saveVotes();
                updateDisplay();
                if (musicEnabled) {
                    updateMusicBasedOnMarket();
                }
            }
        }

        // 右键菜单重置
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            resetVotes();
        });

        // 添加全局点击事件处理 - 解决音频自动播放问题
        document.addEventListener('click', function() {
            debug('页面被点击，音频上下文已激活');
        });
    </script>
</body>
</html>
